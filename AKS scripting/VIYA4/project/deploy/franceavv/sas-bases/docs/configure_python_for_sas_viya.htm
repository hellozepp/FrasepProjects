<html>
    <head>
        <link rel="stylesheet" type="text/css" href="sas.css"/>
        <title>Configure Python for SAS Viya</title>
    </head>
    <body>
        <h1 id="configure-python-for-sas-viya">Configure Python for SAS Viya</h1>
<h2 id="overview">Overview</h2>
<p>SAS Viya can use a customer-prepared environment consisting of a Python installation and any required packages stored on a Kubernetes Persistent Volume. 
This README describes how to make that volume available to your deployment.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>SAS Viya provides YAML files that the Kustomize tool uses to configure Python. Before you use those files, you must perform the following tasks:</p>
<ol>
<li>
<p>Make note of the attributes for the volume where Python and the associated packages are to be deployed. For example, note the server and directory for NFS. 
   For more information about various types of persistent volumes in Kubernetes, see <a href="#additional-resources">Additional Resources</a>.</p>
</li>
<li>
<p>Install Python and any necessary packages on the volume.</p>
</li>
<li>
<p>In addition to the volume attributes, you must have the following information:</p>
<ul>
<li>{{ PYTHON-EXECUTABLE }} - the name of the Python executable file (for example, python or python3.8)</li>
<li>{{ PYTHON-EXE-DIR }} - the directory (relative to the mount) containing the executable (for example, /bin)</li>
<li>{{ SAS-EXTLANG-SETTINGS-XML-FILE }} - configuration file for enabling Python and R integration in CAS. This is only required if you are using Python with CMP or the EXTLANG package.</li>
<li>{{ SAS-EXT-LLP-PYTHON-PATH }} - list of directories to look for when searching for run-time shared libraries (similar to LD_LIBRARY_PATH)</li>
</ul>
</li>
</ol>
<h2 id="installation">Installation</h2>
<ol>
<li>
<p>Copy the files in the <code>$deploy/sas-bases/examples/sas-open-source-config/python</code> directory to the <code>$deploy/site-config/sas-open-source-config/python</code> directory. 
   Create the destination directory, if it does not already exist.</p>
<p><strong>Note:</strong> If the destination directory already exists, <a href="#verify-overlay-for-python-volume">verify that the overlay</a> has been applied.
 If the output contains the <code>/python</code> mount directory path, you do not need to take any further actions, unless you want to change the overlay parameters to use a different Python environment.</p>
</li>
<li>
<p>The kustomization.yaml file defines all the necessary environment variables. Replace all tags, such as {{ PYTHON-EXE-DIR }}, with the values that you gathered in the <a href="#prerequisites">Prerequisites</a> step. 
   Then, set the following parameters, according to the SAS products you will be using:</p>
<ul>
<li>MAS_PYPATH and MAS_M2PATH are used by SAS Micro Analytic Service.</li>
<li>DM_PYPATH is used by the Open Source Code node in SAS Visual Data Mining and Machine Learning. You can add DM_PYPATH2, DM_PYPATH3, DM_PYPATH4 and DM_PYPATH5 if you need to specify multiple Python environments. 
   The Open Source Code node allows you to choose which of these five environment variables to use during execution.</li>
<li>SAS_EXTLANG_SETTINGS is used by applications that run Python and R code on Cloud Analytic Services (CAS). This includes PROC FCMP and the Time Series External Languages (EXTLANG) package. 
   SAS_EXTLANG_SETTINGS should only be set in one example file; for example, if you set it in the Python example, you should not set it the R example.
   SAS_EXTLANG_SETTINGS should point to an XML file that is readable by all users. The path can be in the same volume that contains the R environment or in any other volume that is accessible to CAS. 
   Refer to the documentation for the Time Series External Languages (EXTLANG) package for details on the expected XML schema.</li>
<li>SAS_EXT_LLP_PYTHON is used when the base distribution or packages for open-source software require additional run-time libraries that are not part of the shipped container image.</li>
</ul>
<p><strong>Note:</strong> Any environment variables that you define in this example will be set on all pods, although they might not have an effect. 
 For example, setting MAS_PYPATH will not affect the Python executable used by the EXTLANG package. That executable is set in the SAS_EXTLANG_SETTINGS file. 
 However, if you define $MAS_PYPATH you can then use it in the SAS_EXTLANG_SETTINGS file. For example,</p>
<p><code>&lt;LANGUAGE name="PYTHON3" interpreter="$MAS_PYPATH"&gt;&lt;/LANGUAGE&gt;</code></p>
</li>
<li>
<p>Attach storage to your SAS Viya deployment. The python-transformer.yaml file uses PatchTransformers in Kustomize to attach the volume containing your Python installation to SAS Viya.
   Replace {{ VOLUME-ATTRIBUTES }} with the appropriate volume specification.</p>
<p>For example, when using an NFS mount, the {{ VOLUME-ATTRIBUTES }} tag should be replaced with <code>nfs: {path: /vol/python, server: myserver.sas.com}</code> 
 where <code>myserver.sas.com</code> is the NFS server and <code>/vol/python</code> is the NFS path you recorded in the Prerequisites step.</p>
<p>The relevant code excerpt from python-transformer.yaml file before the change:</p>
<pre class="highlight"><code class="language-yaml">patch: |-
 # Add Python Volume
  - op: add
    path: /spec/template/spec/volumes/-
    value: { name: python-volume, {{ VOLUME-ATTRIBUTES }} }</code></pre>

<p>The relevant code excerpt from python-transformer.yaml file after the change:</p>
<pre class="highlight"><code class="language-yaml">patch: |-
# Add Python Volume
  - op: add
    path: /spec/template/spec/volumes/-
    value: { name: python-volume, nfs: {path: /vol/python, server: myserver.sas.com} }</code></pre>

</li>
<li>
<p>Make the following changes to the base kustomization.yaml file in the $deploy directory.</p>
<ul>
<li>Add site-config/sas-open-source-config/python to the resources block.</li>
<li>Add site-config/sas-open-source-config/python/python-transformer.yaml to the transformers block.</li>
</ul>
<p>Here is an example:</p>
<pre class="highlight"><code class="language-yaml">resources:
- site-config/sas-open-source-config/python

transformers:
- site-config/sas-open-source-config/python/python-transformer.yaml</code></pre>

</li>
<li>
<p>Complete the deployment steps to apply the new settings. See <a href="http://documentation.sas.com/?cdcId=itopscdc&amp;cdcVersion=default&amp;docsetId=dplyml0phy0dkr&amp;docsetTarget=p127f6y30iimr6n17x2xe9vlt54q.htm">Deploy the Software</a> in <em>SAS Viya: Deployment Guide</em>.</p>
<pre><code>**Note:** This overlay can be applied during the initial deployment of SAS Viya or after the deployment of SAS Viya.

* If you are applying the overlay during the initial deployment of SAS Viya, complete all the tasks in the README files that you want to use, then run `kustomize build` to create and apply the manifests.
* If the overlay is applied after the initial deployment of SAS Viya, run `kustomize build` to create and apply the manifests.
</code></pre>
</li>
</ol>
<h2 id="verify-overlay-for-python-volume">Verify Overlay for Python Volume</h2>
<ol>
<li>
<p>Run the following command to verify whether the overlay has been applied:</p>
<pre class="highlight"><code class="language-sh">kubectl describe pod  &lt;sas-microanalyticscore-pod-name&gt; -n &lt;name-of-namespace&gt;</code></pre>

</li>
<li>
<p>Verify that the output contains the following mount directory paths:</p>
<pre class="highlight"><code class="language-yaml">Mounts:
  /python (r)</code></pre>

</li>
</ol>
<h2 id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="http://documentation.sas.com/?cdcId=itopscdc&amp;cdcVersion=default&amp;docsetId=dplyml0phy0dkr&amp;docsetTarget=titlepage.htm">SAS Viya Deployment Guide</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volumes in Kubernetes</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes">Volume Types in Kubernetes</a></li>
<li><a href="http://documentation.sas.com/?cdcId=pgmsascdc&amp;cdcVersion=default&amp;docsetId=castsp&amp;docsetTarget=castsp_extlang_sect002.htm">External Languages Access Control Configuration</a> in <em>SAS Viya Programming Documentation</em></li>
<li><a href="http://documentation.sas.com/?cdcId=mascdc&amp;cdcVersion=default&amp;docsetId=masag&amp;docsetTarget=n149q46z3dnttzn1v4tt2adb1ebc.htm">Configuring SAS Micro Analytic Service to Use a Python Distribution</a> in <em>SAS Micro Analytic Service: Programming and Administration Guide</em></li>
</ul>
    </body>
</html>